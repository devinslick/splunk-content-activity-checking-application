# Test Environment for CACA Splunk App
# This is a generic Kubernetes deployment for testing the CACA app
# Customize the namespace, ingress, and other settings for your environment
#
# To retrieve the generated Splunk password after deployment:
#   kubectl get secret splunk-secret -n splunk-caca -o jsonpath='{.data.password}' | base64 -d

---
# Namespace for CACA test environment
apiVersion: v1
kind: Namespace
metadata:
  name: splunk-caca
---
# ServiceAccount for the password generator job
apiVersion: v1
kind: ServiceAccount
metadata:
  name: splunk-password-generator
  namespace: splunk-caca
---
# Role to allow creating/updating secrets
apiVersion: rbac.authorization.k8s.io/v1
kind: Role
metadata:
  name: splunk-secret-manager
  namespace: splunk-caca
rules:
- apiGroups: [""]
  resources: ["secrets"]
  verbs: ["get", "create", "update", "patch"]
---
# RoleBinding to grant the service account permission
apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding
metadata:
  name: splunk-password-generator
  namespace: splunk-caca
subjects:
- kind: ServiceAccount
  name: splunk-password-generator
  namespace: splunk-caca
roleRef:
  kind: Role
  name: splunk-secret-manager
  apiGroup: rbac.authorization.k8s.io
---
# Job to generate a random password for Splunk
# This runs before the deployment and creates/updates the secret with a random password
apiVersion: batch/v1
kind: Job
metadata:
  name: splunk-password-generator
  namespace: splunk-caca
spec:
  ttlSecondsAfterFinished: 100  # Auto-cleanup after 100 seconds
  template:
    spec:
      serviceAccountName: splunk-password-generator  # Use the service account with permissions
      restartPolicy: Never
      containers:
      - name: generate-password
        image: bitnami/kubectl:latest
        command:
        - /bin/bash
        - -c
        - |
          # Generate a random 16-character password
          PASSWORD=$(cat /dev/urandom | tr -dc 'A-Za-z0-9!@#$%^&*' | head -c 16)

          # Create or update the secret
          kubectl create secret generic splunk-secret \
            --from-literal=password="$PASSWORD" \
            --dry-run=client -o yaml | kubectl apply -f -

          echo "Password secret created/updated successfully"
          echo "Retrieve with: kubectl get secret splunk-secret -o jsonpath='{.data.password}' | base64 -d"
---
# PersistentVolumeClaim for Splunk data
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: splunk
  namespace: splunk-caca
spec:
  accessModes:
    - ReadWriteOnce
  resources:
    requests:
      storage: 10Gi  # Adjust size as needed
  # storageClassName: your-storage-class  # Uncomment and specify if needed
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: splunk
  labels:
    app: splunk
  namespace: splunk-caca
spec:
  replicas: 1
  strategy:
    type: RollingUpdate
    rollingUpdate:
      maxSurge: 1
      maxUnavailable: 1
  selector:
    matchLabels:
      app: splunk
  template:
    metadata:
      labels:
        app: splunk
    spec:
      hostname: splunk
      initContainers:
        - name: download-caca-app
          image: alpine/git:latest
          securityContext:
            runAsUser: 0  # Run as root to ensure write permissions
          env:
            # Change this to use a different branch (e.g., dev, feature/my-feature)
            - name: CACA_BRANCH
              value: "main"
            # Optionally override the GitHub repo URL
            # - name: CACA_REPO_URL
            #   value: "https://github.com/yourusername/your-fork.git"
          command:
            - sh
            - -c
            - |
              set -e  # Exit on any error

              REPO_URL="${CACA_REPO_URL:-https://github.com/devinslick/splunk-content-monitoring-console.git}"

              echo "=== CACA App Installation Starting ==="
              echo "Repository: ${REPO_URL}"
              echo "Branch: ${CACA_BRANCH}"
              echo "Target: /opt/splunk/etc/apps/caca"

              echo "Checking volume mount..."
              ls -la /opt/splunk/etc/ || echo "WARNING: /opt/splunk/etc/ not accessible"

              echo "Creating apps directory if needed..."
              mkdir -p /opt/splunk/etc/apps

              echo "Removing old CACA app installation (if exists)..."
              rm -rf /opt/splunk/etc/apps/caca-content-activity-checking-application
              rm -rf /opt/splunk/etc/apps/caca

              echo "Downloading CACA app from GitHub (branch: ${CACA_BRANCH})..."
              cd /tmp
              git clone --depth 1 --branch ${CACA_BRANCH} ${REPO_URL}

              echo "Creating app directory..."
              mkdir -p /opt/splunk/etc/apps/caca

              echo "Copying app files (excluding dev files)..."
              cd splunk-content-monitoring-console

              # Copy all files except dev-specific ones
              find . -maxdepth 1 -mindepth 1 \
                ! -name '.git*' \
                ! -name 'local' \
                ! -name 'devnotes' \
                ! -name '.venv' \
                ! -name '.pytest_cache' \
                ! -name '.pre-commit-config.yaml' \
                ! -name '.bandit.yml' \
                ! -name 'CI-CD-SETUP.md' \
                ! -name 'scripts' \
                ! -name 'appinspect_report.json' \
                ! -name '*.pyc' \
                ! -name '__pycache__' \
                -exec cp -r {} /opt/splunk/etc/apps/caca/ \;

              echo "Setting permissions for Splunk user (41812)..."
              chown -R 41812:41812 /opt/splunk/etc/apps/caca

              echo "=== CACA App Installation Complete ==="
              echo "Installed files:"
              ls -la /opt/splunk/etc/apps/caca/

              echo "SUCCESS: CACA app installed from ${REPO_URL} (branch: ${CACA_BRANCH})"
          volumeMounts:
            - mountPath: /opt/splunk/etc/apps
              name: splunk
              subPath: var/splunk-apps  # Use a dedicated path in the PVC
      containers:
        - name: splunk
          image: splunk/splunk:latest
          imagePullPolicy: Always
          ports:
            - containerPort: 8000
              name: http
              protocol: TCP
            - containerPort: 8088
              name: hec
              protocol: TCP
            - containerPort: 9997
              name: indexer
              protocol: TCP
          volumeMounts:
          - mountPath: /opt/splunk/var
            name: splunk
            subPath: var
          - mountPath: /opt/splunk/etc/apps
            name: splunk
            subPath: var/splunk-apps  # Share same PVC, different subPath
          env:
            - name: TZ
              value: 'America/Chicago'  # Change to your timezone
            - name: SPLUNK_GENERAL_TERMS
              value: '--accept-sgt-current-at-splunk-com'
            - name: SPLUNK_START_ARGS
              value: '--accept-license --no-prompt --answer-yes'
            - name: SPLUNK_HTTP_PORT
              value: "8000"
            - name: SPLUNK_HEC_PORT
              value: "8088"
            - name: SPLUNK_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: splunk-secret
                  key: password
          livenessProbe:
            httpGet:
              path: /
              port: 8000
            initialDelaySeconds: 60
            periodSeconds: 30
      volumes:
      - name: splunk
        persistentVolumeClaim:
          claimName: splunk  # Change to your PVC name
---
apiVersion: v1
kind: Service
metadata:
  name: splunk-http
  namespace: splunk-caca
  labels:
    app: splunk
spec:
  ports:
  - name: http
    port: 8000
  - name: mgmt
    port: 8089
  type: ClusterIP
  selector:
    app: splunk
---
apiVersion: v1
kind: Service
metadata:
  name: splunk-hec
  namespace: splunk-caca
  labels:
    app: splunk
spec:
  ports:
  - name: hec
    port: 8088
  type: ClusterIP
  selector:
    app: splunk
---
apiVersion: v1
kind: Service
metadata:
  name: splunk-indexer
  namespace: splunk-caca
  labels:
    app: splunk
spec:
  ports:
  - name: indexer
    port: 9997
  type: ClusterIP
  selector:
    app: splunk
---
# Test Runner Job
# Automates the test environment setup: runs registry update, generates traffic, and runs collectors
apiVersion: batch/v1
kind: Job
metadata:
  name: caca-test-runner
  namespace: splunk-caca
spec:
  ttlSecondsAfterFinished: 600
  template:
    spec:
      restartPolicy: Never
      containers:
      - name: test-runner
        image: curlimages/curl:latest
        env:
          - name: SPLUNK_PASSWORD
            valueFrom:
              secretKeyRef:
                name: splunk-secret
                key: password
          - name: SPLUNK_HOST
            value: "splunk-http"
        command:
        - /bin/sh
        - -c
        - |
          echo "Waiting for Splunk Management API (8089)..."
          until curl -s -k -o /dev/null https://${SPLUNK_HOST}:8089/services/server/info; do
            echo "Splunk not ready yet..."
            sleep 10
          done

          # Wait a bit more for login to be fully ready
          echo "Splunk API is responding. Waiting 30s for full startup..."
          sleep 30

          echo "=== 1. Running Registry Update ==="
          curl -k -u admin:${SPLUNK_PASSWORD} https://${SPLUNK_HOST}:8089/services/saved/searches/Dashboard%20Registry%20-%20Auto%20Update/dispatch -d trigger_actions=1 -X POST
          echo "Registry Update Dispatched."
          sleep 5

          echo "=== 2. Generating Traffic (Views) ==="
          DASHBOARDS="dashboard_leaderboard poop_deck caca_admin dashboard_details"
          for dash in $DASHBOARDS; do
            echo "Viewing $dash..."
            for i in 1 2 3; do
              curl -s -u admin:${SPLUNK_PASSWORD} -o /dev/null "http://${SPLUNK_HOST}:8000/en-US/app/splunk-content-monitoring-console/$dash"
            done
          done

          echo "=== 3. Simulating Dashboard Edit ==="
          # Update description to trigger an edit event
          EDIT_URL="https://${SPLUNK_HOST}:8089/servicesNS/admin/splunk-content-monitoring-console/data/ui/views/dashboard_leaderboard"
          DESC="Content Activity Checking Application - Monitor all dashboard usage, health, and activity (Automated Test Edit)"
          curl -k -u admin:${SPLUNK_PASSWORD} $EDIT_URL -d "description=$DESC"
          echo "Dashboard Edited."

          echo "=== 4. Running Metric Collectors ==="
          COLLECTORS="Dashboard%20Views%20-%20Metrics%20Collector Dashboard%20Edits%20-%20Metrics%20Collector Dashboard%20Health%20-%20Metrics%20Collector Dashboard%20Performance%20-%20Metrics%20Collector"
          for collector in $COLLECTORS; do
            echo "Running $collector..."
            curl -k -u admin:${SPLUNK_PASSWORD} https://${SPLUNK_HOST}:8089/services/saved/searches/$collector/dispatch -d trigger_actions=1 -X POST
          done

          echo "=== Test Automation Complete ==="
