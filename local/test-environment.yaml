# Test Environment for CACA Splunk App
# This is a generic Kubernetes deployment for testing the CACA app
# Customize the namespace, ingress, and other settings for your environment
#
# To retrieve the generated Splunk password after deployment:
#   kubectl get secret splunk-secret -n <your-namespace> -o jsonpath='{.data.password}' | base64 -d

---
# Job to generate a random password for Splunk
# This runs before the deployment and creates/updates the secret with a random password
apiVersion: batch/v1
kind: Job
metadata:
  name: splunk-password-generator
  namespace: default  # Change to your namespace
spec:
  ttlSecondsAfterFinished: 100  # Auto-cleanup after 100 seconds
  template:
    spec:
      serviceAccountName: default  # Ensure the service account has permission to create secrets
      restartPolicy: Never
      containers:
      - name: generate-password
        image: bitnami/kubectl:latest
        command:
        - /bin/bash
        - -c
        - |
          # Generate a random 16-character password
          PASSWORD=$(cat /dev/urandom | tr -dc 'A-Za-z0-9!@#$%^&*' | head -c 16)

          # Create or update the secret
          kubectl create secret generic splunk-secret \
            --from-literal=password="$PASSWORD" \
            --dry-run=client -o yaml | kubectl apply -f -

          echo "Password secret created/updated successfully"
          echo "Retrieve with: kubectl get secret splunk-secret -o jsonpath='{.data.password}' | base64 -d"
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: splunk
  labels:
    app: splunk
  namespace: default  # Change to your namespace
spec:
  replicas: 1
  strategy:
    type: RollingUpdate
    rollingUpdate:
      maxSurge: 1
      maxUnavailable: 1
  selector:
    matchLabels:
      app: splunk
  template:
    metadata:
      labels:
        app: splunk
    spec:
      hostname: splunk
      initContainers:
        - name: download-caca-app
          image: alpine/git:latest
          securityContext:
            runAsUser: 0  # Run as root to ensure write permissions
          env:
            # Change this to use a different branch (e.g., dev, feature/my-feature)
            - name: CACA_BRANCH
              value: "main"
            # Optionally override the GitHub repo URL
            # - name: CACA_REPO_URL
            #   value: "https://github.com/yourusername/your-fork.git"
          command:
            - sh
            - -c
            - |
              set -e  # Exit on any error

              REPO_URL="${CACA_REPO_URL:-https://github.com/devinslick/splunk-content-monitoring-console.git}"

              echo "=== CACA App Installation Starting ==="
              echo "Repository: ${REPO_URL}"
              echo "Branch: ${CACA_BRANCH}"
              echo "Target: /opt/splunk/etc/apps/caca"

              echo "Checking volume mount..."
              ls -la /opt/splunk/etc/ || echo "WARNING: /opt/splunk/etc/ not accessible"

              echo "Creating apps directory if needed..."
              mkdir -p /opt/splunk/etc/apps

              echo "Removing old CACA app installation (if exists)..."
              rm -rf /opt/splunk/etc/apps/caca-content-activity-checking-application
              rm -rf /opt/splunk/etc/apps/caca

              echo "Downloading CACA app from GitHub (branch: ${CACA_BRANCH})..."
              cd /tmp
              git clone --depth 1 --branch ${CACA_BRANCH} ${REPO_URL}

              echo "Creating app directory..."
              mkdir -p /opt/splunk/etc/apps/caca

              echo "Copying app files (excluding dev files)..."
              cd splunk-content-monitoring-console

              # Copy all files except dev-specific ones
              find . -maxdepth 1 -mindepth 1 \
                ! -name '.git*' \
                ! -name 'local' \
                ! -name 'devnotes' \
                ! -name '.venv' \
                ! -name '.pytest_cache' \
                ! -name '.pre-commit-config.yaml' \
                ! -name '.bandit.yml' \
                ! -name 'CI-CD-SETUP.md' \
                ! -name 'scripts' \
                ! -name 'appinspect_report.json' \
                ! -name '*.pyc' \
                ! -name '__pycache__' \
                -exec cp -r {} /opt/splunk/etc/apps/caca/ \;

              echo "Setting permissions for Splunk user (41812)..."
              chown -R 41812:41812 /opt/splunk/etc/apps/caca

              echo "=== CACA App Installation Complete ==="
              echo "Installed files:"
              ls -la /opt/splunk/etc/apps/caca/

              echo "SUCCESS: CACA app installed from ${REPO_URL} (branch: ${CACA_BRANCH})"
          volumeMounts:
            - mountPath: /opt/splunk/etc/apps
              name: splunk
              subPath: var/splunk-apps  # Use a dedicated path in the PVC
      containers:
        - name: splunk
          image: splunk/splunk:latest
          imagePullPolicy: Always
          ports:
            - containerPort: 8000
              name: http
              protocol: TCP
            - containerPort: 8088
              name: hec
              protocol: TCP
            - containerPort: 9997
              name: indexer
              protocol: TCP
          volumeMounts:
          - mountPath: /opt/splunk/var
            name: splunk
            subPath: var
          - mountPath: /opt/splunk/etc/apps
            name: splunk
            subPath: var/splunk-apps  # Share same PVC, different subPath
          env:
            - name: TZ
              value: 'America/Chicago'  # Change to your timezone
            - name: SPLUNK_GENERAL_TERMS
              value: '--accept-sgt-current-at-splunk-com'
            - name: SPLUNK_START_ARGS
              value: '--accept-license --no-prompt --answer-yes'
            - name: SPLUNK_HTTP_PORT
              value: "8000"
            - name: SPLUNK_HEC_PORT
              value: "8088"
            - name: SPLUNK_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: splunk-secret
                  key: password
          livenessProbe:
            httpGet:
              path: /
              port: 8000
            initialDelaySeconds: 60
            periodSeconds: 30
      volumes:
      - name: splunk
        persistentVolumeClaim:
          claimName: splunk  # Change to your PVC name
---
apiVersion: v1
kind: Service
metadata:
  name: splunk-http
  namespace: default  # Change to your namespace
  labels:
    app: splunk
spec:
  ports:
  - name: http
    port: 8000
  type: ClusterIP
  selector:
    app: splunk
---
apiVersion: v1
kind: Service
metadata:
  name: splunk-hec
  namespace: default  # Change to your namespace
  labels:
    app: splunk
spec:
  ports:
  - name: hec
    port: 8088
  type: ClusterIP
  selector:
    app: splunk
---
apiVersion: v1
kind: Service
metadata:
  name: splunk-indexer
  namespace: default  # Change to your namespace
  labels:
    app: splunk
spec:
  ports:
  - name: indexer
    port: 9997
  type: ClusterIP
  selector:
    app: splunk
