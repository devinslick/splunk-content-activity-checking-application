# Saved searches for CACA - Content Activity Checking Application
# Version: 1.0.0 - Comprehensive rewrite with improved collectors

#####################
# Data Collection - Metrics Collectors
#####################

# Collects dashboard view metrics from splunkd_ui_access logs
# Runs every 5 minutes to capture recent dashboard access activity
[CACA - Dashboard Views Collector]
action.email.useNSSubject = 1
alert.track = 0
cron_schedule = */5 * * * *
description = Collects dashboard view metrics from splunkd_ui_access logs. Captures user access patterns for all registered dashboards.
dispatch.earliest_time = -6m
dispatch.latest_time = now
enableSched = 1
search = index=_internal sourcetype=splunkd_ui_access uri_path="/*/app/*" status=200 \
| rex field=uri_path "/[^/]+/app/(?<app>[^/]+)/(?<dashboard_name>[^/?]+)" \
| where isnotnull(dashboard_name) \
    AND NOT match(dashboard_name, "^(search|home|launcher|analytics_workspace|report_builder|_)") \
    AND NOT match(uri_path, "\.(js|css|png|jpg|gif|svg|woff|ttf|ico)$") \
| eval dashboard_uri="/app/".app."/".dashboard_name \
| lookup dashboard_registry dashboard_uri OUTPUT pretty_name \
| where isnotnull(pretty_name) \
| stats count as "dashboard.views" by dashboard_uri, pretty_name, app, user \
| eval activity_type="view" \
| mcollect index=caca_metrics split=t pretty_name app user activity_type
schedule_priority = default
schedule_window = 5
dispatchAs = owner

# Collects dashboard edit/creation metrics from audit logs
# Runs every 10 minutes to capture edit activity
[CACA - Dashboard Edits Collector]
action.email.useNSSubject = 1
alert.track = 0
cron_schedule = */10 * * * *
description = Collects dashboard edit and creation metrics from audit logs. Tracks who is actively developing dashboards.
dispatch.earliest_time = -11m
dispatch.latest_time = now
enableSched = 1
search = index=_audit (action=edit_ui_view OR action=create_ui_view) \
| eval dashboard_name=coalesce(name, object) \
| where isnotnull(dashboard_name) AND isnotnull(app) \
| eval dashboard_uri="/app/".app."/".dashboard_name \
| lookup dashboard_registry dashboard_uri OUTPUT pretty_name \
| eval pretty_name=coalesce(pretty_name, dashboard_name) \
| stats count as "dashboard.edits" by dashboard_uri, pretty_name, app, user \
| eval activity_type="edit" \
| mcollect index=caca_metrics split=t pretty_name app user activity_type
schedule_priority = default
schedule_window = 5
dispatchAs = owner

# Collects dashboard health metrics including errors and warnings
# Runs every 15 minutes to capture error/warning patterns
[CACA - Dashboard Health Collector]
action.email.useNSSubject = 1
alert.track = 0
cron_schedule = */15 * * * *
description = Collects dashboard health metrics including errors and warnings from internal logs. Helps identify problematic dashboards.
dispatch.earliest_time = -16m
dispatch.latest_time = now
enableSched = 1
search = index=_internal (sourcetype=splunkd OR sourcetype=splunkd_ui_access) (log_level=ERROR OR log_level=WARN OR status>=400) \
    (component=ScheduledViewsReporter OR component=DashboardController OR component=SimpleXML OR component=ViewsRender OR uri_path="/*/app/*") \
| rex field=_raw "view[=:](?<dashboard_name_raw>[^\s,\"]+)" \
| rex field=_raw "app[=:](?<app_raw>[^\s,\"]+)" \
| rex field=uri_path "/[^/]+/app/(?<app_uri>[^/]+)/(?<dashboard_name_uri>[^/?]+)" \
| eval dashboard_name=coalesce(dashboard_name_raw, dashboard_name_uri) \
| eval app=coalesce(app_raw, app_uri) \
| where isnotnull(dashboard_name) AND isnotnull(app) \
    AND NOT match(dashboard_name, "^(search|home|launcher|_)") \
| eval dashboard_uri="/app/".app."/".dashboard_name \
| lookup dashboard_registry dashboard_uri OUTPUT pretty_name \
| where isnotnull(pretty_name) \
| eval severity=lower(coalesce(log_level, if(status>=500, "error", if(status>=400, "warn", "info")))) \
| stats count as "dashboard.errors" by dashboard_uri, pretty_name, app, severity \
| eval activity_type="health" \
| mcollect index=caca_metrics split=t pretty_name app severity activity_type
schedule_priority = default
schedule_window = 5
dispatchAs = owner

# Collects dashboard load time and performance metrics via REST API
# Runs every 10 minutes to measure actual search performance
[CACA - Dashboard Performance Collector]
action.email.useNSSubject = 1
alert.track = 0
cron_schedule = */10 * * * *
description = Collects dashboard load time and performance metrics via REST API. Measures actual search execution times for dashboard panels.
dispatch.earliest_time = -11m
dispatch.latest_time = now
enableSched = 1
search = | rest /services/search/jobs count=0 \
| rename eai:acl.app as app, author as user, runDuration as runtime, provenance as provenance \
| search provenance="UI:Dashboard*" OR provenance="scheduler__*" \
| rex field=provenance "UI:Dashboard:(?<dashboard_name>.+)" \
| where isnotnull(dashboard_name) \
| eval dashboard_uri="/app/".app."/".dashboard_name \
| lookup dashboard_registry dashboard_uri OUTPUT pretty_name \
| where isnotnull(pretty_name) \
| eval runtime_ms=round(runtime*1000, 0) \
| stats avg(runtime_ms) as avg_runtime_ms sum(runtime_ms) as total_runtime_ms count as search_count by dashboard_uri, pretty_name, app, user \
| eval "dashboard.load_time"=round(avg_runtime_ms, 0) \
| where "dashboard.load_time" > 0 \
| eval activity_type="performance" \
| mcollect index=caca_metrics split=t pretty_name app user activity_type
schedule_priority = default
schedule_window = 5
dispatchAs = owner

#####################
# Additional Collectors
#####################

# Collects unique user counts per dashboard
# Runs hourly to track user engagement patterns
[CACA - Dashboard User Engagement Collector]
action.email.useNSSubject = 1
alert.track = 0
cron_schedule = 5 * * * *
description = Collects unique user engagement metrics per dashboard. Tracks how many distinct users access each dashboard.
dispatch.earliest_time = -61m
dispatch.latest_time = now
enableSched = 1
search = index=_internal sourcetype=splunkd_ui_access uri_path="/*/app/*" status=200 \
| rex field=uri_path "/[^/]+/app/(?<app>[^/]+)/(?<dashboard_name>[^/?]+)" \
| where isnotnull(dashboard_name) \
    AND NOT match(dashboard_name, "^(search|home|launcher|analytics_workspace|_)") \
| eval dashboard_uri="/app/".app."/".dashboard_name \
| lookup dashboard_registry dashboard_uri OUTPUT pretty_name \
| where isnotnull(pretty_name) \
| stats dc(user) as "dashboard.unique_users" values(user) as users by dashboard_uri, pretty_name, app \
| eval activity_type="engagement" \
| mcollect index=caca_metrics split=t pretty_name app activity_type
schedule_priority = default
schedule_window = 5
dispatchAs = owner

#####################
# Registry Maintenance
#####################

# Automatically updates dashboard registry via REST API
# Runs daily at 2 AM to discover new dashboards and update metadata
[CACA - Dashboard Registry Auto Update]
action.email.useNSSubject = 1
alert.track = 0
cron_schedule = 0 2 * * *
description = Automatically updates dashboard registry via REST API. Discovers new dashboards and updates metadata for all registered dashboards.
dispatch.earliest_time = -5m
dispatch.latest_time = now
enableSched = 1
search = | rest /services/data/ui/views count=0 \
| search isDashboard=1 OR isVisible=1 \
| eval dashboard_uri="/app/".'eai:acl.app'."/".title \
| eval pretty_name=coalesce(label, title) \
| eval app='eai:acl.app' \
| eval owner='eai:acl.owner' \
| eval sharing='eai:acl.sharing' \
| rex field="eai:data" "<description>(?<xml_description>.*?)</description>" \
| eval description=coalesce(xml_description, "") \
| eval status="active" \
| eval last_updated=strftime(now(), "%Y-%m-%d %H:%M:%S") \
| lookup app_filter app OUTPUT include \
| where isnull(include) OR include="true" OR include="1" OR include="yes" \
| fields - include \
| table dashboard_uri pretty_name app owner sharing description status last_updated \
| outputlookup dashboard_registry.csv
schedule_priority = default
dispatchAs = owner

# Cleanup old/orphaned entries from registry
# Runs weekly to remove dashboards that no longer exist
[CACA - Dashboard Registry Cleanup]
action.email.useNSSubject = 1
alert.track = 0
cron_schedule = 0 3 * * 0
description = Cleans up orphaned entries from the dashboard registry by removing dashboards that no longer exist in Splunk.
dispatch.earliest_time = -5m
dispatch.latest_time = now
enableSched = 1
search = | inputlookup dashboard_registry \
| join type=left dashboard_uri \
    [| rest /services/data/ui/views count=0 \
    | eval dashboard_uri="/app/".'eai:acl.app'."/".title \
    | eval exists="yes" \
    | table dashboard_uri exists] \
| where exists="yes" \
| fields - exists \
| outputlookup dashboard_registry.csv
schedule_priority = default
dispatchAs = owner

#####################
# Alerting & Reporting
#####################

# Alert for dashboards with critical errors
# Runs every 30 minutes to detect dashboards in critical state
[CACA - Critical Dashboard Alert]
action.email.useNSSubject = 1
alert.track = 1
alert.suppress = 1
alert.suppress.period = 4h
alert.suppress.fields = pretty_name
cron_schedule = */30 * * * *
description = Alerts when dashboards have critical error levels. Triggers when error count exceeds critical threshold.
dispatch.earliest_time = -4h
dispatch.latest_time = now
enableSched = 0
search = | mstats sum(_value) as error_count WHERE index=caca_metrics AND metric_name="dashboard.errors" BY pretty_name, app span=1h \
| stats sum(error_count) as total_errors by pretty_name, app \
| appendpipe [| inputlookup caca_settings where setting_name="error_threshold_critical" | eval _merge="settings"] \
| eventstats values(setting_value) as critical_threshold \
| where isnotnull(pretty_name) AND total_errors >= coalesce(critical_threshold, 10) \
| fields - critical_threshold _merge setting_name setting_value setting_description \
| lookup dashboard_registry pretty_name OUTPUT owner \
| table pretty_name app owner total_errors
schedule_priority = default
dispatchAs = owner

# Alert for slow dashboards
# Runs hourly to detect performance degradation
[CACA - Slow Dashboard Alert]
action.email.useNSSubject = 1
alert.track = 1
alert.suppress = 1
alert.suppress.period = 4h
alert.suppress.fields = pretty_name
cron_schedule = 15 * * * *
description = Alerts when dashboards have critically slow load times. Triggers when average load time exceeds critical threshold.
dispatch.earliest_time = -4h
dispatch.latest_time = now
enableSched = 0
search = | mstats avg(_value) as avg_load WHERE index=caca_metrics AND metric_name="dashboard.load_time" BY pretty_name, app span=1h \
| stats avg(avg_load) as avg_load_time by pretty_name, app \
| appendpipe [| inputlookup caca_settings where setting_name="load_time_critical" | eval _merge="settings"] \
| eventstats values(setting_value) as critical_threshold \
| where isnotnull(pretty_name) AND avg_load_time >= coalesce(critical_threshold, 10000) \
| eval avg_load_time=round(avg_load_time, 0) \
| fields - critical_threshold _merge setting_name setting_value setting_description \
| lookup dashboard_registry pretty_name OUTPUT owner \
| table pretty_name app owner avg_load_time
schedule_priority = default
dispatchAs = owner

#####################
# Summary Reports
#####################

# Daily summary report of all dashboard activity
# Runs daily at 6 AM for the previous day's data
[CACA - Daily Activity Summary]
action.email.useNSSubject = 1
alert.track = 0
cron_schedule = 0 6 * * *
description = Generates a daily summary report of all dashboard activity including views, edits, errors, and performance metrics.
dispatch.earliest_time = -1d@d
dispatch.latest_time = @d
enableSched = 0
search = | mstats sum(_value) as metric_value WHERE index=caca_metrics AND metric_name="dashboard.*" BY pretty_name, metric_name, app span=1d \
| stats sum(metric_value) as total by pretty_name, metric_name, app \
| eval metric_type=case(\
    metric_name=="dashboard.views", "views",\
    metric_name=="dashboard.edits", "edits",\
    metric_name=="dashboard.errors", "errors",\
    metric_name=="dashboard.load_time", "load_time",\
    1=1, "other") \
| eval {metric_type}=total \
| stats values(app) as app sum(views) as views sum(edits) as edits sum(errors) as errors avg(load_time) as avg_load_time by pretty_name \
| fillnull value=0 views edits errors \
| eval avg_load_time=round(coalesce(avg_load_time, 0), 0) \
| eval health_status=case(\
    errors > 10, "critical",\
    errors > 0, "warning",\
    views == 0, "inactive",\
    1=1, "healthy") \
| lookup dashboard_registry pretty_name OUTPUT owner \
| sort -views \
| table pretty_name app owner views edits errors avg_load_time health_status
schedule_priority = default
dispatchAs = owner

# Weekly trend report
# Runs weekly on Monday at 7 AM
[CACA - Weekly Trend Report]
action.email.useNSSubject = 1
alert.track = 0
cron_schedule = 0 7 * * 1
description = Generates a weekly trend report comparing this week's metrics to the previous week.
dispatch.earliest_time = -14d@d
dispatch.latest_time = @d
enableSched = 0
search = | mstats sum(_value) as metric_value WHERE index=caca_metrics AND metric_name="dashboard.views" BY pretty_name, app span=1d \
| eval week=if(_time >= relative_time(now(), "-7d@d"), "current_week", "previous_week") \
| stats sum(metric_value) as views by pretty_name, app, week \
| eval {week}=views \
| stats values(app) as app sum(current_week) as views_current sum(previous_week) as views_previous by pretty_name \
| fillnull value=0 views_current views_previous \
| eval change=views_current-views_previous \
| eval change_pct=if(views_previous>0, round((change/views_previous)*100, 1), 0) \
| eval trend=case(\
    change_pct > 20, "Growing",\
    change_pct > 0, "Stable+",\
    change_pct == 0, "Stable",\
    change_pct > -20, "Declining",\
    1=1, "Dropping") \
| lookup dashboard_registry pretty_name OUTPUT owner \
| sort -change_pct \
| table pretty_name app owner views_current views_previous change change_pct trend
schedule_priority = default
dispatchAs = owner

#####################
# Sample Data Generation (For Testing Only)
#####################

# Generates sample dashboard metrics for testing
# Run manually to populate the caca_metrics index with test data
[CACA - Generate Sample Data]
action.email.useNSSubject = 1
alert.track = 0
description = Generates sample dashboard metrics for testing purposes. Run manually to populate the caca_metrics index with realistic test data. Disable in production.
dispatch.earliest_time = -5m
dispatch.latest_time = now
enableSched = 0
search = | makeresults count=100 \
| streamstats count as row \
| eval dashboard_names=split("Sales Dashboard,Executive Summary,Operations Overview,Customer Analytics,Network Monitor,Security Dashboard,IT Infrastructure,Marketing Metrics,Finance Report,HR Dashboard", ",") \
| eval app_names=split("search,sales_app,ops_app,analytics_app,network_app", ",") \
| eval users=split("admin,analyst1,analyst2,manager,viewer1,viewer2", ",") \
| eval pretty_name=mvindex(dashboard_names, row % 10) \
| eval app=mvindex(app_names, row % 5) \
| eval user=mvindex(users, row % 6) \
| eval metric_types=split("views,edits,errors,load_time", ",") \
| mvexpand metric_types \
| eval metric_name="dashboard.".metric_types \
| eval base_value=case(\
    metric_types=="views", random() % 50 + 1,\
    metric_types=="edits", random() % 5,\
    metric_types=="errors", if(random() % 10 < 2, random() % 3, 0),\
    metric_types=="load_time", 500 + (random() % 5000),\
    1=1, 1) \
| eval _value=base_value \
| eval activity_type=case(\
    metric_types=="views", "view",\
    metric_types=="edits", "edit",\
    metric_types=="errors", "health",\
    metric_types=="load_time", "performance",\
    1=1, "unknown") \
| eval severity=if(metric_types=="errors" AND _value > 0, if(random() % 2 == 0, "error", "warn"), null()) \
| where _value > 0 OR metric_types=="load_time" \
| table _time pretty_name app user metric_name activity_type severity _value \
| mcollect index=caca_metrics split=t pretty_name app user activity_type severity
schedule_priority = default
dispatchAs = owner

# Populates sample dashboard registry for testing
[CACA - Generate Sample Registry]
action.email.useNSSubject = 1
alert.track = 0
description = Generates sample dashboard registry entries for testing. Run manually to populate the dashboard_registry lookup with test dashboards.
dispatch.earliest_time = -5m
dispatch.latest_time = now
enableSched = 0
search = | makeresults \
| eval data="Sales Dashboard|/app/sales_app/sales_dashboard|sales_app|admin|global|Real-time sales metrics and KPIs|active,Executive Summary|/app/search/executive_summary|search|admin|global|Executive overview dashboard|active,Operations Overview|/app/ops_app/ops_overview|ops_app|analyst1|app|Operations monitoring dashboard|active,Customer Analytics|/app/analytics_app/customer_analytics|analytics_app|analyst2|global|Customer behavior analytics|active,Network Monitor|/app/network_app/network_monitor|network_app|admin|global|Network health monitoring|active,Security Dashboard|/app/search/security_dashboard|search|admin|global|Security alerts and events|active,IT Infrastructure|/app/ops_app/it_infrastructure|ops_app|manager|app|IT systems overview|active,Marketing Metrics|/app/analytics_app/marketing_metrics|analytics_app|analyst1|app|Marketing campaign performance|active,Finance Report|/app/search/finance_report|search|manager|user|Financial reports dashboard|active,HR Dashboard|/app/search/hr_dashboard|search|manager|user|Human resources metrics|active" \
| eval rows=split(data, ",") \
| mvexpand rows \
| eval parts=split(rows, "|") \
| eval pretty_name=mvindex(parts, 0) \
| eval dashboard_uri=mvindex(parts, 1) \
| eval app=mvindex(parts, 2) \
| eval owner=mvindex(parts, 3) \
| eval sharing=mvindex(parts, 4) \
| eval description=mvindex(parts, 5) \
| eval status=mvindex(parts, 6) \
| eval last_updated=strftime(now(), "%Y-%m-%d %H:%M:%S") \
| table dashboard_uri pretty_name app owner sharing description status last_updated \
| outputlookup dashboard_registry.csv
schedule_priority = default
dispatchAs = owner
