# Saved searches for CACA - Content Activity Checking Application

#####################
# Data Collection - Metrics Collectors
#####################

[Dashboard Views - Metrics Collector]
action.email.useNSSubject = 1
alert.track = 0
cron_schedule = */5 * * * *
description = Collects dashboard view metrics from splunkd_ui_access logs
dispatch.earliest_time = -5m
dispatch.latest_time = now
enableSched = 0
search = index=_internal sourcetype=splunkd_ui_access uri_path="/*/app/*" | rex field=uri_path "/[^/]+/app/(?<app>[^/]+)/(?<dashboard_name>[^/?]+)" | where isnotnull(dashboard_name) | eval dashboard_uri="/app/".app."/".dashboard_name | lookup dashboard_registry dashboard_uri OUTPUT pretty_name app as reg_app owner | where isnotnull(pretty_name) | stats count by dashboard_uri, pretty_name, app, user | eval activity_type="view", metric_name="dashboard.views" | mcollect index=caca_metrics split=t pretty_name app user activity_type
schedule_priority = default
schedule_window = 5
dispatchAs = owner

[Dashboard Edits - Metrics Collector]
action.email.useNSSubject = 1
alert.track = 0
cron_schedule = */10 * * * *
description = Collects dashboard edit/creation metrics from audit logs
dispatch.earliest_time = -10m
dispatch.latest_time = now
enableSched = 0
search = index=_audit (action=rest_apps_view_post OR action=rest_apps_view_put) object_type=view OR object="*:*" | rex field=object "(?<app>[^:]+):(?<dashboard_name>.+)" | eval dashboard_uri="/app/".app."/".dashboard_name | lookup dashboard_registry dashboard_uri OUTPUT pretty_name app as reg_app owner | where isnotnull(pretty_name) | stats count by dashboard_uri, pretty_name, app, user, action | eval activity_type=if(action="rest_apps_view_post", "create", "edit"), metric_name="dashboard.edits" | mcollect index=caca_metrics split=t pretty_name app user activity_type
schedule_priority = default
schedule_window = 5
dispatchAs = owner

[Dashboard Health - Metrics Collector]
action.email.useNSSubject = 1
alert.track = 0
cron_schedule = */15 * * * *
description = Collects dashboard health metrics including errors and performance
dispatch.earliest_time = -15m
dispatch.latest_time = now
enableSched = 0
search = index=_internal (sourcetype=splunkd log_level=ERROR OR log_level=WARN) (component=ScheduledViewsReporter OR component=DashboardController OR component=SimpleXML) | rex field=_raw "view=(?<dashboard_name>[^\\s,]+)" | rex field=_raw "app=(?<app>[^\\s,]+)" | where isnotnull(dashboard_name) AND isnotnull(app) | eval dashboard_uri="/app/".app."/".dashboard_name | lookup dashboard_registry dashboard_uri OUTPUT pretty_name app as reg_app owner | where isnotnull(pretty_name) | stats count by dashboard_uri, pretty_name, app, log_level | eval severity=lower(log_level), activity_type="health", metric_name="dashboard.errors" | mcollect index=caca_metrics split=t pretty_name app severity activity_type
schedule_priority = default
schedule_window = 5
dispatchAs = owner

[Dashboard Performance - Metrics Collector]
action.email.useNSSubject = 1
alert.track = 0
cron_schedule = */10 * * * *
description = Collects dashboard load time and performance metrics
dispatch.earliest_time = -10m
dispatch.latest_time = now
enableSched = 0
search = index=_internal sourcetype=splunkd_ui_access uri_path="/*/app/*" | rex field=uri_path "/[^/]+/app/(?<app>[^/]+)/(?<dashboard_name>[^/?]+)" | where isnotnull(dashboard_name) AND isnotnull(spent) | eval dashboard_uri="/app/".app."/".dashboard_name | lookup dashboard_registry dashboard_uri OUTPUT pretty_name app as reg_app owner | where isnotnull(pretty_name) | eval load_time_ms=tonumber(spent) | where isnotnull(load_time_ms) AND load_time_ms > 0 | stats sum(load_time_ms) as total_load_time, count as request_count by dashboard_uri, pretty_name, app, user | eval _value=round(total_load_time/request_count, 2), activity_type="performance", metric_name="dashboard.load_time" | mcollect index=caca_metrics split=t _value pretty_name app user activity_type
schedule_priority = default
schedule_window = 5
dispatchAs = owner

#####################
# Registry Maintenance
#####################

[Dashboard Registry - Auto Update]
action.email.useNSSubject = 1
alert.track = 0
cron_schedule = 0 2 * * *
description = Automatically updates dashboard registry via REST API, respecting app filter configuration
dispatch.earliest_time = -5m
dispatch.latest_time = now
enableSched = 0
search = | rest /services/data/ui/views splunk_server=local count=0 | search isDashboard=1 OR isVisible=1 | eval dashboard_uri="/app/".'eai:acl.app'."/".title | eval pretty_name=coalesce(label, title) | eval app='eai:acl.app' | eval owner='eai:acl.owner' | eval sharing='eai:acl.sharing' | eval description=coalesce('eai:data', "") | eval status="active" | lookup app_filter app OUTPUT include | where isnull(include) OR include="true" OR include="1" OR include="yes" | fields - include | table dashboard_uri pretty_name app owner sharing description status | outputlookup dashboard_registry.csv
schedule_priority = default
dispatchAs = owner
